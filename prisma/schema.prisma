// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// Internal account construct (one per user in v3)
model Account {
  id        String    @id @default(cuid())
  createdAt DateTime  @default(now())
  deletedAt DateTime? // Epic 6: tombstone marker for hybrid delete
  
  user      User?
  forms     Form[]
  
  @@map("accounts")
}

// Admin user account
model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  password            String    // bcrypt hashed
  createdAt           DateTime  @default(now())
  
  // Link to internal account (one-to-one in v3)
  accountId           String    @unique
  account             Account   @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // Auth telemetry
  lastLoginAt         DateTime?
  failedLoginCount    Int       @default(0)
  lastFailedLoginAt   DateTime?
  
  createdForms        Form[]  @relation("CreatedForms")
  passwordResetTokens PasswordResetToken[]
  
  @@map("users")
}

// Form configuration
model Form {
  id                        String   @id @default(cuid())
  accountId                 String
  createdByUserId           String
  name                      String
  slug                      String   // Account-unique, for admin URLs
  allowedOrigins            String[] @default([])  // Domains allowed to embed/submit to this form
  notifyEmails              String[] @default([])
  emailNotificationsEnabled Boolean  @default(false)  // Epic 4: Email account owner on new submission
  honeypotField             String?  // Optional honeypot field name
  successMessage            String?
  redirectUrl               String?
  defaultTheme              Json?
  stopAt                    DateTime? // Stop accepting submissions after this date/time
  maxSubmissions            Int?      // Maximum number of submissions allowed
  createdAt                 DateTime @default(now())
  
  account         Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)
  createdByUser   User         @relation("CreatedForms", fields: [createdByUserId], references: [id], onDelete: Cascade)
  fields          Field[]
  submissions     Submission[]
  
  @@unique([accountId, slug])
  @@index([accountId])
  @@index([createdByUserId])
  @@map("forms")
}

model Field {
  id          String    @id @default(cuid())
  formId      String
  name        String
  type        FieldType
  label       String
  placeholder String?
  required    Boolean   @default(false)
  order       Int
  options     Json?
  validation  Json?
  helpText    String?

  form        Form      @relation(fields: [formId], references: [id], onDelete: Cascade)

  @@unique([formId, name])
  @@index([formId, order])
  @@map("fields")
}

// Form submission
model Submission {
  id        String           @id @default(cuid())
  formId    String
  data      Json             // Arbitrary form payload
  meta      Json             // IP hash, user agent, referrer, origin
  isSpam    Boolean          @default(false)
  status    SubmissionStatus @default(NEW)
  createdAt DateTime         @default(now())
  
  form      Form             @relation(fields: [formId], references: [id], onDelete: Cascade)
  
  @@index([formId])
  @@index([status])
  @@index([isSpam])
  @@map("submissions")
}

enum SubmissionStatus {
  NEW
  READ
  ARCHIVED
}

enum FieldType {
  TEXT
  EMAIL
  TEXTAREA
  SELECT
  CHECKBOX
  HIDDEN
  PHONE
  DATE
  NAME
}

// Password reset tokens
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}
