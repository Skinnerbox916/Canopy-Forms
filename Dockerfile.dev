# syntax=docker/dockerfile:1

FROM node:20-alpine

# Install dependencies
RUN apk add --no-cache libc6-compat
WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies (will be preserved by anonymous volume in docker-compose)
RUN npm ci

# Copy source code (will be overridden by volume mount in dev mode)
COPY . .

# Generate Prisma Client (will be regenerated if needed)
RUN npx prisma generate || true

# Build embed script (will be rebuilt if needed)
RUN npm run embed:build || true

# Expose port
EXPOSE 3000

# Set environment to development
ENV NODE_ENV=development

# Create entrypoint script that ensures dependencies are installed
RUN echo '#!/bin/sh' > /entrypoint.sh && \
    echo 'if [ ! -d "/app/node_modules" ] || [ ! -f "/app/node_modules/.bin/next" ]; then' >> /entrypoint.sh && \
    echo '  echo "Installing dependencies..."' >> /entrypoint.sh && \
    echo '  npm ci' >> /entrypoint.sh && \
    echo '  npx prisma generate' >> /entrypoint.sh && \
    echo '  npm run embed:build' >> /entrypoint.sh && \
    echo 'fi' >> /entrypoint.sh && \
    echo 'exec npm run dev' >> /entrypoint.sh && \
    chmod +x /entrypoint.sh

# Run entrypoint script
CMD ["/entrypoint.sh"]
